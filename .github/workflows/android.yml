name: Build & Upload Flutter APK to GitHub Releases

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g. v1.2.3). If empty, will use the current ref name."
        required: false
        default: ""

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Build release APK
        run: flutter build apk --release

      - name: Resolve tag + rename APK
        id: prep
        shell: bash
        run: |
          set -euo pipefail

          # Prefer workflow_dispatch input tag if provided, else use ref name (tags use GITHUB_REF_NAME).
          TAG_INPUT="${{ inputs.tag }}"
          if [[ -n "$TAG_INPUT" ]]; then
            TAG="$TAG_INPUT"
          else
            TAG="${GITHUB_REF_NAME}"
          fi

          if [[ -z "$TAG" ]]; then
            echo "❌ Tag could not be resolved. Provide inputs.tag or run on a tag push."
            exit 1
          fi

          APK="build/app/outputs/flutter-apk/app-release.apk"
          if [[ ! -f "$APK" ]]; then
            echo "❌ APK not found at $APK"
            echo "Listing flutter-apk output:"
            ls -la build/app/outputs/flutter-apk || true
            exit 1
          fi

          OUT="build/app/outputs/flutter-apk/app-${TAG}-release.apk"
          cp "$APK" "$OUT"

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "apk=$OUT" >> "$GITHUB_OUTPUT"

      - name: Create Release and upload APK
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.prep.outputs.tag }}
          name: ${{ steps.prep.outputs.tag }}
          generate_release_notes: true
          files: ${{ steps.prep.outputs.apk }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
