name: Build Android APK

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      # This workflow supports:
      # 1) Pure Android/Gradle projects (gradlew anywhere in repo)
      # 2) Flutter projects (android/ exists but gradlew might not be present; builds via flutter)
      #
      # It auto-detects gradlew first. If not found, it tries Flutter build.
      - name: Detect build system
        id: detect
        shell: bash
        run: |
          set -euo pipefail

          echo "== Repo top-level =="
          ls -la

          # Find gradlew anywhere (ignore node_modules / build dirs)
          GRADLEW_PATH="$(find . -type f -name "gradlew" \
            -not -path "*/node_modules/*" \
            -not -path "*/build/*" \
            -not -path "*/.gradle/*" \
            -print -quit || true)"

          if [[ -n "${GRADLEW_PATH}" ]]; then
            GRADLE_DIR="$(dirname "${GRADLEW_PATH}")"
            echo "Found gradlew at: ${GRADLEW_PATH}"
            echo "gradle_dir=${GRADLE_DIR}" >> "$GITHUB_OUTPUT"
            echo "mode=gradle" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # If no gradlew, try detecting Flutter
          if [[ -f "pubspec.yaml" ]]; then
            echo "No gradlew found. pubspec.yaml detected -> Flutter project."
            echo "mode=flutter" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "❌ Could not find gradlew anywhere AND pubspec.yaml not found."
          echo "You likely didn't commit the Gradle wrapper, or your Android project is in a subfolder you didn't include."
          echo "Fix by committing wrapper files: gradlew, gradlew.bat, gradle/wrapper/*"
          exit 1

      # ---------- Gradle / Android build ----------
      - name: Build Debug APK (Gradle)
        if: steps.detect.outputs.mode == 'gradle'
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ steps.detect.outputs.gradle_dir }}"
          chmod +x ./gradlew
          ./gradlew --no-daemon assembleDebug

      - name: Find APK output (Gradle)
        if: steps.detect.outputs.mode == 'gradle'
        id: apk_gradle
        shell: bash
        run: |
          set -euo pipefail
          ROOT="${{ steps.detect.outputs.gradle_dir }}"

          # Search for debug APKs produced by Gradle
          APK_PATHS="$(find "$ROOT" -type f -name "*debug*.apk" -path "*/outputs/apk/*" || true)"
          if [[ -z "$APK_PATHS" ]]; then
            echo "❌ No debug APK found under $ROOT/**/outputs/apk/"
            echo "Listing outputs for debugging:"
            find "$ROOT" -maxdepth 6 -type d -path "*outputs*" -print || true
            exit 1
          fi

          echo "Found APK(s):"
          echo "$APK_PATHS"
          # Upload all matching APKs
          echo "apk_paths<<EOF" >> "$GITHUB_OUTPUT"
          echo "$APK_PATHS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Upload APK artifact (Gradle)
        if: steps.detect.outputs.mode == 'gradle'
        uses: actions/upload-artifact@v4
        with:
          name: apk-debug-gradle
          path: ${{ steps.apk_gradle.outputs.apk_paths }}

      # ---------- Flutter build ----------
      - name: Set up Flutter
        if: steps.detect.outputs.mode == 'flutter'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: stable
          cache: true

      - name: Flutter pub get
        if: steps.detect.outputs.mode == 'flutter'
        run: flutter pub get

      - name: Build Debug APK (Flutter)
        if: steps.detect.outputs.mode == 'flutter'
        run: flutter build apk --debug

      - name: Find APK output (Flutter)
        if: steps.detect.outputs.mode == 'flutter'
        id: apk_flutter
        shell: bash
        run: |
          set -euo pipefail

          APK_PATHS="$(find . -type f -name "*.apk" -path "*/build/app/outputs/flutter-apk/*" || true)"
          if [[ -z "$APK_PATHS" ]]; then
            echo "❌ No Flutter APK found under build/app/outputs/flutter-apk/"
            echo "Listing build outputs for debugging:"
            find . -maxdepth 6 -type d -path "*build*" -print || true
            exit 1
          fi

          echo "Found APK(s):"
          echo "$APK_PATHS"
          echo "apk_paths<<EOF" >> "$GITHUB_OUTPUT"
          echo "$APK_PATHS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Upload APK artifact (Flutter)
        if: steps.detect.outputs.mode == 'flutter'
        uses: actions/upload-artifact@v4
        with:
          name: apk-debug-flutter
          path: ${{ steps.apk_flutter.outputs.apk_paths }}
